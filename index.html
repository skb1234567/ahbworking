<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travel Agency Form</title>
  <style>
    /* Basic Reset & Defaults */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px; /* Add some padding around the whole page */
      background-color: #e9ebee; /* Light background for the page */
      color: #333;
      line-height: 1.6;
    }

    * {
      
    }

    /* Form Container Styling */
    .form-container {
      width: 90%; /* Responsive width */
      max-width: 300px; /* Max width for larger screens */
      margin: 30px auto; /* Centering and margin */
      padding: 25px 30px; /* More padding */
      background-color: #ffffff; /* White background for forms */
      border-radius: 12px; /* Softer corners */
    }

    /* Headings */
    h2, h3 {
      color: #0056b3; /* A theme color */
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }

    /* Labels */
    label {
      display: block; /* Each label on its own line */
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    /* Input Fields, Select, Textarea */
    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="date"],
    select {
      width: 90%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: #007bff; /* Highlight on focus */
      outline: none; /* Remove default outline */
    }

    input[readonly] {
      background-color: #f0f0f0; /* Style for readonly fields */
      cursor: not-allowed;
    }

    /* Buttons */
    button, .button-like {
      background-color: #007bff;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      display: inline-block; /* For proper spacing and alignment */
      text-align: center;
    }

    button:hover, .button-like:hover {
      background-color: #0056b3;
      transform: translateY(-2px); /* Slight lift on hover */
    }

    button[type="submit"] {
      width: 100%; /* Make submit button full width */
      margin-top: 10px;
    }

    /* Button Bar */
    .button-bar {
      text-align: center;
      margin: 25px 0;
      display: flex; /* Use flexbox for better alignment */
      justify-content: space-evenly; /* Distribute buttons */
      flex-wrap: wrap; /* Allow buttons to wrap on small screens */
      gap: 10px; /* Space between buttons */
    }

    .button-bar button {
      min-width: 150px; /* Minimum width for buttons in bar */
    }


    /* WhatsApp Button Container */
    #whatsappButtonContainer {
      display: none;
      text-align: center;
      margin-top: 25px;
    }

    #whatsappLink {
      background-color: #25D366;
      color: white;
      padding: 12px 25px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #whatsappLink:hover {
      background-color: #1DA851;
      transform: translateY(-2px);
    }

    /* Table Styling for Search Results */
    .table-responsive-wrapper {
        overflow-x: 100%; /* Allows table to be scrolled horizontally on small screens */
        margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px; /* Space above table */
    }

    th, td {
      border: 1px solid #ddd; /* Lighter border */
      padding: 10px 12px; /* More padding */
      text-align: left;
      white-space: nowrap; /* Keep content on one line, relies on wrapper for scrolling */
    }

    th {
      background-color: #007bff; /* Header background */
      color: white;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9; /* Zebra striping for rows */
    }

    tr:hover {
      background-color: #f1f1f1; /* Hover effect for rows */
    }

    /* Popup Message */
    .popup {
      display: none;
      position: fixed;
      top: 20px; /* Positioned at the top */
      left: 50%;
      transform: translateX(-50%); /* Centered horizontally */
      padding: 15px 25px;
      background-color: #4CAF50;
      color: white;
      border-radius: 8px;
      font-size: 18px;
      box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000; /* Ensure it's on top */
      animation: fadeIn 0.5s, fadeOut 0.5s 4s forwards; /* Keep fadeOut state */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translate(-50%, 0); }
      to { opacity: 0; transform: translate(-50%, -20px); }
    }

    /* Specific Section Display */
    #loginSection, #branchSection, #formSection, #searchSection {
        /* Styles for these are mostly handled by .form-container now */
    }

    #branchName {
        color: #28a745; /* Green color for branch name */
        font-weight: bold;
    }

    #searchResult p {
        text-align: center;
        font-style: italic;
        color: #777;
        margin-top: 15px;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      .form-container {
        padding: 20px;
      }

      h2 {
        font-size: 1.5em;
      }

      .button-bar {
        flex-direction: column; /* Stack buttons in the bar */
      }

      .button-bar button {
        width: 100%; /* Full width for stacked buttons */
        margin-bottom: 10px;
      }

      th, td {
        padding: 8px;
        font-size: 14px; /* Smaller font for table content on mobile */
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .form-container {
        padding: 15px;
      }
      input[type="text"],
      input[type="password"],
      input[type="number"],
      input[type="date"],
      select, button {
        font-size: 15px; /* Slightly smaller font for very small screens */
      }
      h2 {
        font-size: 1.3em;
      }
    }

  </style>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbx1OULfRXdLoAux8EEVXQF9xXhM83dnG6sSwkxjbsYqXoqhZmBN_NFoV4F5hu87zzPP/exec";

    const branchData = {
      "Muhammad Shahzad": { password: "1234", branchName: "Muhammad Shahzad" },
      "Muhammad Madni": { password: "5678", branchName: "Muhammad Madni" },
      "Rana Usman": { password: "91011", branchName: "Rana Usman" },
      "Muhammad Tahir": { password: "1213", branchName: "Muhammad Tahir" }
    };

    let currentBranch = ""; // To store the name of the currently logged-in branch

    function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      if (branchData[username] && branchData[username].password === password) {
        currentBranch = branchData[username].branchName; // Store the branch name
        document.getElementById("branchName").innerText = currentBranch;
        document.getElementById("loggedInBranchInput").value = currentBranch; // Set it in the hidden input for the form
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("branchSection").style.display = "block";
        showSection('form'); // Show form section by default after login
      } else {
        alert("Incorrect username or password");
      }
    }

    function calculateProfit() {
      const costPrice = parseFloat(document.getElementById("costPrice").value) || 0;
      const cashTaken = parseFloat(document.getElementById("cashTaken").value) || 0;
      document.getElementById("profit").value = cashTaken - costPrice;
    }

    function calculateBalance() {
      const receivedCash = parseFloat(document.getElementById("receivedCash").value) || 0;
      const cashTaken = parseFloat(document.getElementById("cashTaken").value) || 0;
      document.getElementById("balance").value = receivedCash - cashTaken;
    }

    function handleSubmit(event) {
      event.preventDefault();
      const form = document.getElementById("travelForm");
      const formData = new FormData(form);

      // The 'branch' field is now an input and will be included automatically.
      // formData.set("branch", currentBranch); // This is no longer strictly needed if using the input field correctly

      const mobileNumberRaw = (formData.get("mobileNumber") || "").replace(/\D/g, '');
      const customerName = formData.get("customerName");
      const pnr = formData.get("pnr");
      const tripType = formData.get("tripType");
      const travelDate = formData.get("travelDate");
      const costPrice = formData.get("costPrice");
      const cashTaken = formData.get("cashTaken");
      const receivedCash = formData.get("receivedCash");
      const balance = formData.get("balance");
      const profit = formData.get("profit"); // Get profit for the message

      const message = `
*Your Booking is Confirmed!*

*Dear* ${customerName}
*Mobile Number:* ${mobileNumberRaw}
*Booking Reference* ${pnr}
*Trip Type:* ${tripType}
*Travel Date:* ${travelDate}

*Cash Taken:* ${cashTaken}
*Received Cash:* ${receivedCash}
*Balance Due:* ${balance}

*Branch:* ${currentBranch}
_Thank you again for choosing Al Harbi Travels. We hope you have a wonderful trip_
`.trim();

      // Basic validation for mobile number prefix
      let countryCode = "";
      if (mobileNumberRaw.startsWith("03")) { // Common Pakistan prefix
          countryCode = "92"; // Pakistan
      } else if (mobileNumberRaw.startsWith("05")) { // Common KSA prefix like 050, 055, 05...
          countryCode = "966"; // Saudi Arabia
      } else if (mobileNumberRaw.length === 10 && !mobileNumberRaw.startsWith("0")) { // Assuming direct number without leading 0 for some cases
          // Potentially needs more specific logic if multiple countries with 10-digit numbers are common
          // For now, let's assume if it doesn't fit PK or KSA clearly, we don't prefix, or you can add a default
      }


      let fullMobile = mobileNumberRaw;
      // If country code is determined, and number starts with '0', remove '0' before prepending country code
      if (countryCode && mobileNumberRaw.startsWith('0')) {
        fullMobile = `${countryCode}${mobileNumberRaw.substring(1)}`;
      } else if (countryCode) {
        fullMobile = `${countryCode}${mobileNumberRaw}`;
      }
      // If no country code, use the number as is (or decide a default action)


      const whatsappLink = `https://wa.me/${fullMobile}?text=${encodeURIComponent(message)}`;
      document.getElementById("whatsappLink").href = whatsappLink;
      document.getElementById("whatsappButtonContainer").style.display = "block";

      fetch(scriptURL, {
        method: "POST",
        body: formData
      })
        .then(res => res.text())
        .then(data => {
          showPopup("Form submitted successfully!");
          form.reset();
          document.getElementById("profit").value = ''; // Clear calculated fields
          document.getElementById("balance").value = ''; // Clear calculated fields
          document.getElementById("loggedInBranchInput").value = currentBranch; // Re-set branch after form reset
          document.getElementById("whatsappButtonContainer").style.display = "block"; // Hide WhatsApp button after successful submit & reset
        })
        .catch(err => {
          showPopup("Error submitting form. Please try again.");
          console.error("Form submission error:", err);
        });
    }

    function showPopup(message) {
      const popup = document.getElementById("popupMessage");
      popup.innerText = message;
      popup.style.display = "block";
      // Ensure fadeOut animation completes and then hides
      setTimeout(() => {
        popup.style.display = "none";
      }, 4500); // Animation is 0.5s in, 0.5s out, shown for 4s in between
    }

    function showSection(section) {
      document.getElementById("formSection").style.display = section === "form" ? "block" : "none";
      document.getElementById("searchSection").style.display = section === "search" ? "block" : "none";

      // If showing form section, ensure the current branch is populated
      if (section === "form") {
        document.getElementById("loggedInBranchInput").value = currentBranch;
      }
    }

    function searchRecord() {
      const query = document.getElementById("searchQuery").value.trim();
      if (!query) {
        document.getElementById("searchResult").innerHTML = "<p>Please enter a mobile number or PNR to search.</p>";
        return;
      }

      document.getElementById("searchResult").innerHTML = "<p>Searching...</p>"; // Provide feedback

      fetch(`${scriptURL}?action=search&search=${encodeURIComponent(query)}&branch=${encodeURIComponent(currentBranch)}`) // Added action=search
        .then(res => {
            if (!res.ok) {
                throw new Error(`Network response was not ok: ${res.statusText}`);
            }
            return res.json();
        })
        .then(data => {
          const resultDiv = document.getElementById("searchResult");
          if (data.error) {
            resultDiv.innerHTML = `<p>Error: ${data.error}</p>`;
            return;
          }
          if (data.length === 0) {
            resultDiv.innerHTML = "<p>No record found.</p>";
            return;
          }

          let html = "<h4>Search Result:</h4><div class='table-responsive-wrapper'><table><thead><tr>"; // Added thead
          // Assuming all objects have the same keys, use the first object for headers
          Object.keys(data[0]).forEach(key => {
            // Simple way to make keys more readable (e.g., customerName -> Customer Name)
            const headerText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            html += `<th>${headerText}</th>`;
          });
          html += "</tr></thead><tbody>"; // Added tbody

          data.forEach(row => {
            html += "<tr>";
            Object.values(row).forEach(val => {
              html += `<td>${val !== null && val !== undefined ? val : ''}</td>`; // Handle null/undefined values
            });
            html += "</tr>";
          });

          html += "</tbody></table></div>";
          resultDiv.innerHTML = html;
        })
        .catch(err => {
          document.getElementById("searchResult").innerHTML = "<p>Search failed. Please check the console for errors.</p>";
          console.error("Search error:", err);
        });
    }

    // Initialize the form section visibility based on login status
    document.addEventListener('DOMContentLoaded', () => {
        // By default, only login section is visible
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("branchSection").style.display = "none";
        document.getElementById("formSection").style.display = "none";
        document.getElementById("searchSection").style.display = "none";
    });

  </script>
</head>
<body>

  <div id="loginSection" class="form-container">
    <h2>Branch Login</h2>
    <form onsubmit="handleLogin(event)">
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required>

      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required>

      <button type="submit">Login</button>
    </form>
  </div>

  <div id="branchSection" style="display: none;">
    <div class="form-container"> <h2>Welcome: <span id="branchName"></span></h2>
        <div class="button-bar">
          <button onclick="showSection('form')">New Entry Form</button>
          <button onclick="showSection('search')">Search Records</button>
        </div>
    </div>
  </div>

  <div id="formSection" class="form-container" style="display: none;">
    <h2>Travel Agency Form</h2>
    <form id="travelForm" onsubmit="handleSubmit(event)">
      <label for="customerName">Customer Name:</label>
      <input type="text" id="customerName" name="customerName" required>

      <label for="mobileNumber">Mobile Number:</label>
      <input type="text" id="mobileNumber" name="mobileNumber" required pattern="^\d{10,11}$" title="Enter a 10 or 11 digit mobile number">

      <label for="pnr">PNR:</label>
      <input type="text" id="pnr" name="pnr" required>

      <label for="tripType">Trip Type:</label>
      <select id="tripType" name="tripType" required>
        <option value="" disabled selected>Select Trip Type</option>
        <option value="One Way">One Way</option>
        <option value="Return">Return</option>
      </select>

      <label for="travelDate">Travel Date:</label>
      <input type="date" id="travelDate" name="travelDate" required>

      <label for="costPrice">Cost Price:</label>
      <input type="number" id="costPrice" name="costPrice" oninput="calculateProfit()" required>

      <label for="cashTaken">Cash Taken (Sale Price):</label>
      <input type="number" id="cashTaken" name="cashTaken" oninput="calculateProfit(); calculateBalance()" required>

      <label for="profit">Profit:</label>
      <input type="number" id="profit" name="profit" readonly>

      <label for="receivedCash">Received Cash (from customer):</label>
      <input type="number" id="receivedCash" name="receivedCash" oninput="calculateBalance()" required>

      <label for="balance">Balance (Customer Due):</label>
      <input type="number" id="balance" name="balance" readonly>

      <input type="hidden" id="loggedInBranchInput" name="branch">

      <button type="submit">Submit & Generate WhatsApp</button>
    </form>

    <div id="whatsappButtonContainer">
      <a id="whatsappLink" href="#" target="_blank" class="button-like">Send on WhatsApp</a>
    </div>
  </div>

  <div id="popupMessage" class="popup"></div> <div id="searchSection" class="form-container" style="display: none;">
    <h3>Search Record</h3>
    <form onsubmit="event.preventDefault(); searchRecord();">
      <label for="searchQuery">Enter Mobile Number or PNR:</label>
      <input type="text" id="searchQuery" name="searchQuery" required>
      <button type="submit">Search</button>
    </form>
    <div id="searchResult" style="margin-top: 20px;">
        </div>
  </div>

</body>
</html>
